<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:i="http://java.sun.com/jsf/composite/imixs"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:marty="http://java.sun.com/jsf/composite/marty"
	template="/layout/template.xhtml">

	<ui:define name="content">


		<!-- Documentinfo: $UniqueID= #{reportController.workitem.item['$uniqueid']}-->
		<f:view>
			<h:form id="report_form_id">
				<div class="imixs-form">
					<div class="imixs-header">
						<h1>
							<h:outputText value="#{message['report.title']}: " />
							<h:outputText
								value="#{reportController.workitem.item['txtname']} " />
						</h1>
					</div>


					<!-- ########## Error message ########## -->
					<div class="ui-widget" id="imixs-report-errormessage"
						style="display: none;">
						<div class="ui-state-error ui-corner-all"
							style="padding: .7em; margin-bottom: .7em;">
							<h2>
								#{message.error_title} <span class="ui-icon ui-icon-alert"
									style="float: left; margin-right: .3em;"> </span>
							</h2>
							<p>
								<h:outputText sxtyle="color: red"
									value="#{message.error_message}" />
							</p>
							<p>
								<h:messages globalOnly="true" />
							</p>
						</div>
					</div>


					<div class="imixs-body">
						<f:ajax event="change" render=":report_form_id:hidden_uri">

							<div class="imixs-form-panel">
								<h1>Parameter</h1>
								<div class="imixs-form-section-2">

									<ui:repeat
										value="#{reportController.params.keySet().toArray()}"
										var="key">
										<dl>
											<dt>
												<h:outputLabel value="#{key}:" />
												<span class="imixs-required">*</span>
											</dt>
											<dd>
												<input type="text" data-param="#{key}"
													class="imixs-report-param" />
											</dd>
										</dl>

									</ui:repeat>
								</div>
							</div>
							<div class="imixs-form-panel">
								<h1>Format</h1>
								<div class="imixs-form-section-2">

									<dl>
										<dt>Output:</dt>
										<dd>
											<select id="imixs-report-output">
												<option value="html">HTML</option>
												<option value="xml">XML</option>
												<option value="json">JSON</option>
											</select>
										</dd>
									</dl>
									<dl>
										<dt>Count:</dt>
										<dd>
											<input type="text" id="imixs-report-count" />
										</dd>
									</dl>
									
									<dl>
										<dt>Encoding:</dt>
										<dd>
											<input type="text" id="imixs-report-encoding" />
										</dd>
									</dl>
								</div>
							</div>

						</f:ajax>

					</div>

					<div class="imixs-footer">

						<!-- open report -->
						<input type="button" onclick="openReport();"
							value="#{message.open}" />

						<h:commandButton immediate="true" value="#{message.close}"
							action="reports" />

						<h:commandButton action="reports" immediate="true"
							rendered="#{loginController.isUserInRole('org.imixs.ACCESSLEVEL.MANAGERACCESS')}"
							onclick="if (!confirm('#{message.help_delete}')) return false;"
							actionListener="#{reportController.delete(reportController.workitem.item['$uniqueid'])}"
							value="#{message.delete}">
						</h:commandButton>
					</div>

				</div>
			</h:form>

			<script type="text/javascript">
				/*<![CDATA[*/
				var reportBaseURI = "#{facesContext.externalContext.requestContextPath}/rest-service/report/";
				var reportName= "#{reportController.workitem.item['txtname']}";
				
				// check of date input fields
				$(document).ready(function() {
					var paramList = $('.imixs-report-param');
					$(paramList).each(
							function(index, value) {
								var paramName = $(this).attr("data-param");
								// add datepicker
								if (paramName.startsWith('date_')) {
									$(this).addClass('imixs-date').datepicker({
										showOtherMonths : true,
										selectOtherMonths : true,
										dateFormat : "yy-mm-dd"
									});
								}
							});
				});
				
				
				// test if all params are provided and open URI
				function openReport() {
					var reportURI = "";
					var encoding = $('#imixs-report-encoding').val();
					var count = $('#imixs-report-count').val();
					var outputFormat = $('#imixs-report-output').val();
					var paramList = $('.imixs-report-param');
					var paramsValid = true;
					
					// report name
					if (reportName.indexOf(".")>-1) {
						reportName = reportName.substring(0, reportName.indexOf('.'));
					}
					// default count?
					if (!count) {
						count="-1";
					}

					reportURI = reportURI+reportBaseURI + reportName + "." + outputFormat + "?count="+count;
					
					if (encoding) {
						reportURI = reportURI + "&encoding=" + encoding;
					}

					// build param list
					$(paramList).each(
							function(index, value) {
								var paramName = $(this).attr("data-param");
								var paramValue = $(this).val();
								if (!paramValue) {
									// error no value found!
									paramsValid = false;
									return false;
								} else {
									reportURI = reportURI + "&" + paramName
											+ "=" + paramValue;
								}
							});

					if (paramsValid) {
						$("#imixs-report-errormessage").hide();
						window.open(reportURI).focus();
					} else {
						$("#imixs-report-errormessage").show();
					}

				}

				/*]]>*/
			</script>



		</f:view>
	</ui:define>



</ui:composition>

